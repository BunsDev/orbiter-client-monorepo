# This file is generated by Nx.

# Build the docker image with `npx nx docker-build explore-server`.
# Tip: Modify "docker-build" options in project.json to change docker build args.

# Use the Node.js LTS Alpine image as the base image.
FROM docker.io/node:lts-alpine

# Install build dependencies for node-gyp.
RUN apk add g++ make python3

# Set environment variables for the application.
ENV HOST=0.0.0.0
ENV PORT=3000

# Set the working directory in the container.
WORKDIR /app

# Create a system user and group for the explore-server application.
RUN addgroup --system explore-server && \
    adduser --system -G explore-server explore-server

# Copy package.json, yarn.lock, and the application code to the container.
COPY package.json yarn.lock ./
COPY dist/apps/explore-server explore-server

# Change ownership of the copied files to the explore-server user.
RUN chown -R explore-server:explore-server .

# Configure Yarn to use a Taobao registry for faster package downloads.
RUN yarn config set registry https://registry.npm.taobao.org
RUN yarn config set ignore-engines true

# Install application dependencies with Yarn, with an increased network timeout.
RUN yarn install --network-timeout 600000

# Start the explore-server application.
CMD [ "node", "explore-server/main.js" ]
